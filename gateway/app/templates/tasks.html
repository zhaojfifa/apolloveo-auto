<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>{{ t("page.tasks.board.title") }} - ShortVideo</title>
  <link rel="stylesheet" href="/static/tasks_board.css">
  <link rel="stylesheet" href="/static/i18n.css" />
  <link rel="stylesheet" href="/static/css/ui_v185.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { primary: '#4f46e5' } } } };
  </script>
</head>
{% macro tr(key, fallback) -%}
  {%- set v = t(key) -%}
  {%- if (v is string) and v.startswith('[') and v.endswith(']') -%}
    {{ fallback }}
  {%- else -%}
    {{ v }}
  {%- endif -%}
{%- endmacro %}

<body class="bg-gray-50 text-slate-900 {{ 'mobile' if is_mobile else 'desktop' }}">
  <header class="sticky top-0 z-30 border-b border-gray-200 bg-white/90 backdrop-blur">
    <div class="mx-auto max-w-7xl px-4 py-4 sm:px-6 lg:px-8">
      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div>
          <div class="flex items-center gap-2">
            <h1 class="text-2xl font-bold text-gray-900">{{ t("page.tasks.board.title") }}</h1>
            <span class="rounded-full bg-gray-100 px-2 py-0.5 text-xs text-gray-600">v1.9</span>
          </div>
          <p class="mt-1 text-sm text-gray-500">{{ t("page.tasks.board.subtitle") if t("page.tasks.board.subtitle") else "v1.9 Release | ??????" }}</p>
        </div>

        <div class="flex flex-wrap items-center gap-2 justify-end">
          <!-- Status Tabs (client-side filter) -->
          <nav class="inline-flex rounded-lg border border-gray-200 bg-white p-1 text-sm">
            <button class="tab-btn rounded-md px-3 py-1.5 data-[active=true]:bg-gray-900 data-[active=true]:text-white"
                    data-filter="all" data-active="true">{{ tr("page.tasks.tab.all", "??") }}</button>
            <button class="tab-btn rounded-md px-3 py-1.5 text-gray-700 hover:bg-gray-50"
                    data-filter="processing">{{ tr("page.tasks.tab.processing", "???") }}</button>
            <button class="tab-btn rounded-md px-3 py-1.5 text-gray-700 hover:bg-gray-50"
                    data-filter="done">{{ tr("page.tasks.tab.done", "???") }}</button>
            <button class="tab-btn rounded-md px-3 py-1.5 text-gray-700 hover:bg-gray-50"
                    data-filter="attention">{{ tr("page.tasks.tab.attention", "??(?????)") }}</button>
          </nav>

          <!-- KEEP EXISTING LANGUAGE SWITCHER BLOCK HERE (paste your current HTML+JS, unchanged) -->
          <div class="ml-1">
            {% include "_lang_tabs.html" %}
          </div>

          <a href="/tasks/new"
             class="inline-flex items-center rounded-md bg-primary px-3 py-2 text-sm font-semibold text-white shadow-sm hover:opacity-90">
            + {{ tr("page.tasks.new", "????") }}
          </a>
        </div>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
    <div class="bg-white shadow-sm ring-1 ring-gray-900/5 sm:rounded-xl">
      <ul role="list" class="divide-y divide-gray-100">
        {% for task in tasks %}
          {% set db = (task.status or '')|lower %}
          {% set pack_exists = task.pack_path %}
          {% set is_done = pack_exists or (db == 'ready') %}
          {% set is_processing = (not is_done) and (db in ['queued','running']) %}
          {% set needs_attention = (db == 'failed') and (not pack_exists) %}
          {% set yellow = (db == 'failed') and pack_exists %}

          <li class="task-row relative flex justify-between gap-x-6 px-4 py-4 sm:px-6 hover:bg-gray-50
                     {% if yellow %} bg-yellow-50/30 {% endif %}"
              data-db="{{ db }}"
              data-pack="{{ 1 if pack_exists else 0 }}">

            <div class="flex min-w-0 gap-x-4">
              <div class="h-16 w-16 flex-none rounded-lg bg-gray-200 overflow-hidden flex items-center justify-center">
                {% if task.thumb_url %}
                  <img class="h-full w-full object-cover" src="{{task.thumb_url}}" alt="thumb" />
                {% else %}
                  <span class="text-gray-400 text-xl"></span>
                {% endif %}
              </div>

              <div class="min-w-0 flex-auto">
                <p class="text-sm font-semibold leading-6 text-gray-900 line-clamp-1">
                  {{ task.title or ('task_' ~ task.task_id) }}
                </p>
                <p class="mt-1 flex text-xs leading-5 text-gray-500 gap-2">
                  <span>{{ task.platform or '?' }}</span>
                  <span>?</span>
                  <span>ID: {{ task.task_id }}</span>
                  {% if task.account_name %}<span>?</span><span>@{{task.account_name}}</span>{% endif %}
                </p>

                <div class="mt-2 flex gap-2 flex-wrap items-center">
                  {% if pack_exists %}
                    <span class="inline-flex items-center rounded-md bg-green-50 px-2 py-1 text-xs font-medium text-green-700 ring-1 ring-inset ring-green-600/20">
                       Pack {{ 'Ready' if is_done else 'Exists' }}
                    </span>
                  {% endif %}

                  <span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium ring-1 ring-inset
                               {% if db == 'failed' %} bg-amber-50 text-amber-700 ring-amber-600/20
                               {% elif db in ['queued','running'] %} bg-blue-50 text-blue-700 ring-blue-700/10
                               {% else %} bg-gray-50 text-gray-700 ring-gray-300 {% endif %}
                               {% if pack_exists %} opacity-60 {% endif %}">
                    DB: {{ task.status }}
                  </span>

                  {% if yellow %}
                    <span class="text-xs text-amber-700 ml-1">{{ tr("page.tasks.hint.degraded_but_usable", "?????????") }}</span>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="flex items-center gap-x-4">
              <div class="hidden sm:flex sm:flex-col sm:items-end">
                <p class="text-sm leading-6 text-gray-900">{{ task.category_key or '-' }}</p>
              </div>

              <div class="flex items-center gap-2">
                {% if pack_exists %}
                  {% if db == 'failed' %}
                    <a href="/v1/tasks/{{task.task_id}}/pack"
                       class="rounded bg-indigo-50 px-2 py-1 text-sm font-semibold text-indigo-600 ring-1 ring-inset ring-indigo-300 hover:bg-indigo-100">
                      {{ tr("page.tasks.action.force_download", "????") }}
                    </a>
                  {% else %}
                    <a href="/v1/tasks/{{task.task_id}}/pack"
                       class="rounded bg-white px-2 py-1 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                      {{ tr("page.tasks.action.download_pack", "????") }}
                    </a>
                  {% endif %}
                {% else %}
                  <button class="rounded bg-gray-100 px-2 py-1 text-sm font-semibold text-gray-400 cursor-not-allowed">
                    {{ tr("page.tasks.action.download_pack", "????") }}
                  </button>
                {% endif %}

                <a href="/tasks/{{task.task_id}}" class="text-gray-400 hover:text-gray-600">?</a>
              </div>
            </div>
          </li>
        {% endfor %}
      </ul>
    </div>
  </main>

  <script src="/static/js/i18n_v185.js"></script>
  <script>
    // Client-side filter tabs (no backend changes)
    const tabs = document.querySelectorAll('.tab-btn');
    const rows = document.querySelectorAll('.task-row');

    function flags(row){
      const db = (row.dataset.db || '').toLowerCase();
      const pack = row.dataset.pack === '1';
      const done = pack || db === 'ready';
      const processing = !done && (db === 'queued' || db === 'running');
      const attention = (db === 'failed' && !pack);
      return {done, processing, attention};
    }

    tabs.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        tabs.forEach(b=>b.dataset.active='false');
        btn.dataset.active='true';
        const f = btn.dataset.filter;
        rows.forEach(r=>{
          const s = flags(r);
          let show = true;
          if (f==='processing') show = s.processing;
          if (f==='done') show = s.done;
          if (f==='attention') show = s.attention;
          r.style.display = show ? '' : 'none';
        });
      });
    });
  </script>

  <script>
    (async function hydrateKindLabels(){
      try{
        const res = await fetch('/static/ui/scene_labels.v1.json', { cache: 'no-store' });
        if (!res.ok) return;
        const map = await res.json();
        const lang = (document.documentElement.lang || 'zh').startsWith('en') ? 'en' : 'zh';
        document.querySelectorAll('.kind-label[data-kind]').forEach(el=>{
          const code = (el.getAttribute('data-kind') || '').trim();
          if (!code) return;
          const entry = map[code];
          if (entry && entry[lang]) el.textContent = entry[lang];
        });
      }catch(e){
        // silent fail: fallback remains code
      }
    })();
  </script>

</body>
</html>
