<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>{{ t("page.tasks.board.title") }} - ShortVideo</title>
  <link rel="stylesheet" href="/static/tasks_board.css">
  <link rel="stylesheet" href="/static/i18n.css" />
  <link rel="stylesheet" href="/static/css/ui_v185.css">
  <style>
    :root { color-scheme: light; }
    body {
      margin: 0;
      padding: 16px;
      background: #f3f4f6;
      color: #0f172a;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .page { max-width: 1200px; margin: 0 auto; }
    .card {
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
      padding: 16px;
    }
    .header { margin-bottom: 12px; }
    h1 { margin: 0; font-size: 1.5rem; font-weight: 700; color: #0f172a; }
    .subhead { margin: 4px 0 0; color: #6b7280; font-size: 0.95rem; }
    .bilingual { display: flex; flex-direction: column; gap: 2px; }
    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 12px;
      align-items: center;
      margin-top: 8px;
      font-size: 0.85rem;
      color: #475569;
    }
    .legend-title { font-weight: 600; color: #111827; }
    .legend-item { display: inline-flex; align-items: center; gap: 6px; }
    .badge-dot { width: 10px; height: 10px; border-radius: 999px; display: inline-block; }
    .dot-ready { background: #22c55e; }
    .dot-processing { background: #f59e0b; }
    .dot-pending { background: #38bdf8; }
    .dot-error { background: #ef4444; }
    .btn-primary {
      background: #2563eb;
      color: #ffffff;
      padding: 10px 14px;
      border-radius: 10px;
      text-decoration: none;
      font-weight: 700;
      font-size: 0.95rem;
      display: inline-block;
    }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
      padding: 10px 14px;
      border-radius: 10px;
      text-decoration: none;
      font-weight: 700;
      font-size: 0.95rem;
      display: inline-block;
    }
    .btn-secondary:hover { background: #d1d5db; }
    .header-actions { display: flex; gap: 10px; align-items: center; }
    .table-wrapper { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    thead { background: #f9fafb; color: #475569; }
    th, td { padding: 12px 10px; border-bottom: 1px solid #e5e7eb; text-align: left; vertical-align: top; }
    th { font-weight: 700; font-size: 0.9rem; }
    a { color: #2563eb; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .muted { color: #6b7280; font-size: 0.95rem; }
    .badge { padding: 4px 10px; border-radius: 999px; font-size: 0.8rem; font-weight: 700; display: inline-block; }
    .badge-ready { background: #dcfce7; color: #15803d; }
    .badge-processing { background: #fef3c7; color: #b45309; }
    .badge-pending { background: #e0f2fe; color: #0369a1; }
    .badge-error { background: #fee2e2; color: #b91c1c; }
    .badge-unknown { background: #e5e7eb; color: #374151; }
    .truncate { max-width: 240px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .empty { padding: 12px 0; }
    .secondary { display: block; color: #6b7280; font-size: 0.85rem; }
    .action-stack { display: flex; flex-direction: column; gap: 6px; }
    .action-item { display: flex; flex-direction: column; gap: 2px; }
    .link-button {
      background: none;
      border: none;
      padding: 0;
      color: #2563eb;
      font-size: 0.9rem;
      text-align: left;
      cursor: pointer;
    }
    .link-button:hover { text-decoration: underline; }
    .link-button.danger { color: #dc2626; }
    @media (max-width: 768px) {
      thead { display: none; }
      table, tbody, tr, td { display: block; width: 100%; }
      tr { background: #fff; border: 1px solid #e5e7eb; border-radius: 14px; margin-bottom: 16px; padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
      td { border: none; padding: 8px 10px; }
      td::before {
        content: att(data-label);
        display: block;
        font-weight: 700;
        color: #111827;
        margin-bottom: 2px;
      }
    }
  </style>
</head>
<body class="{{ 'mobile' if is_mobile else 'desktop' }}">
{% set ui_show_secondary = false %}
  <div class="page tasks-board">
    <div class="card">
      {% set topbar_title = t("ui.tasks.board") %}
{% set topbar_subtitle = t("tasks.loaded_n", n=(tasks | length)) %}
{% set avatar_active = (tasks_kind == "apollo_avatar") %}
{% set topbar_nav = [
  {"label": "数字人", "href": "/tasks?kind=apollo_avatar", "active": avatar_active},
  {"label": "热点跟随", "href": "/tasks/hot-follow", "active": False},
  {"label": "工具", "href": "/tools/hub", "active": False},
] %}
{% set topbar_actions = [
  {"label": "新建数字人" if avatar_active else t("common.new_task"), "href": "/tasks/apollo-avatar/new" if avatar_active else "/tasks/new", "primary": True},
] %}
{% include "_topbar.html" %}


      <div class="legend">
        <span class="legend-title">{{ t("tasks.legend") }}</span>
        <span class="legend-item">
          <span class="badge-dot dot-ready"></span>
          <span>{{ t("tasks.legend.ready") }}</span>
        </span>
        <span class="legend-item">
          <span class="badge-dot dot-processing"></span>
          <span>{{ t("tasks.legend.processing") }}</span>
        </span>
        <span class="legend-item">
          <span class="badge-dot dot-pending"></span>
          <span>{{ t("tasks.legend.queued") }}</span>
        </span>
        <span class="legend-item">
          <span class="badge-dot dot-error"></span>
          <span>{{ t("tasks.legend.failed") }}</span>
        </span>
      </div>

      <div class="table-wrapper">
        {% set delete_label = t("action.delete") %}
        <table class="tasks-table">
          <thead>
            <tr>
              <th class="bilingual">
                <span>{{ t("tasks.table.id") }}</span>
                {% if ui_show_secondary %}
                  <span class="secondary">{{ t("tasks.table.id") }}</span>
                {% endif %}
              </th>
              <th class="bilingual">
                <span>{{ t("tasks.table.platform") }}</span>
                {% if ui_show_secondary %}
                  <span class="secondary">{{ t("tasks.table.platform") }}</span>
                {% endif %}
              </th>
              <th class="bilingual">
                <span>{{ t("tasks.table.source") }}</span>
                {% if ui_show_secondary %}
                  <span class="secondary">{{ t("tasks.table.source") }}</span>
                {% endif %}
              </th>
              <th class="bilingual">
                <span>{{ t("tasks.table.title") }}</span>
                {% if ui_show_secondary %}
                  <span class="secondary">{{ t("tasks.table.title") }}</span>
                {% endif %}
              </th>
              <th class="bilingual">
                <span>{{ t("tasks.table.category") }}</span>
                {% if ui_show_secondary %}
                  <span class="secondary">{{ t("tasks.table.category") }}</span>
                {% endif %}
              </th>
              <th class="bilingual">
                <span>{{ t("tasks.table.language") }}</span>
                {% if ui_show_secondary %}
                  <span class="secondary">{{ t("tasks.table.language") }}</span>
                {% endif %}
              </th>
              <th class="bilingual">
                <span>{{ t("tasks.table.status") }}</span>
                {% if ui_show_secondary %}
                  <span class="secondary">{{ t("tasks.table.status") }}</span>
                {% endif %}
              </th>
              <th class="bilingual">
                <span>{{ t("tasks.table.created") }}</span>
                {% if ui_show_secondary %}
                  <span class="secondary">{{ t("tasks.table.created") }}</span>
                {% endif %}
              </th>
              <th class="bilingual">
                <span>{{ t("tasks.table.pack") }}</span>
                {% if ui_show_secondary %}
                  <span class="secondary">{{ t("tasks.table.pack") }}</span>
                {% endif %}
              </th>
              <th class="bilingual">
                <span>{{ t("tasks.table.publish") }}</span>
                {% if ui_show_secondary %}
                  <span class="secondary">{{ t("tasks.table.publish") }}</span>
                {% endif %}
              </th>
              <th class="bilingual">
                <span>{{ t("tasks.table.detail") }}</span>
                {% if ui_show_secondary %}
                  <span class="secondary">{{ t("tasks.table.detail") }}</span>
                {% endif %}
              </th>
            </tr>
          </thead>
          <tbody id="task-table-body">
            {% for task in tasks %}
              {% set status = (task.status or "unknown")|lower %}
              {% if status == "ready" %}
                {% set status_key = "tasks.status.ready" %}
              {% elif status == "processing" %}
                {% set status_key = "tasks.status.processing" %}
              {% elif status == "pending" %}
                {% set status_key = "tasks.status.queued" %}
              {% elif status == "error" %}
                {% set status_key = "tasks.status.failed" %}
              {% else %}
                {% set status_key = "tasks.status.failed" %}
              {% endif %}
              {% if status == "ready" %}
                {% set badge = "badge badge-ready" %}
              {% elif status == "processing" %}
                {% set badge = "badge badge-processing" %}
              {% elif status == "pending" %}
                {% set badge = "badge badge-pending" %}
              {% elif status == "error" %}
                {% set badge = "badge badge-error" %}
              {% else %}
                {% set badge = "badge badge-unknown" %}
              {% endif %}

              {% set cat_key = task.category_key or "-" %}
              {% if cat_key == "suitcase" %}
                {% set cat_label_primary = t("category_suitcase") %}
                {% set cat_label_secondary = t("category_suitcase") %}
              {% elif cat_key == "beauty" %}
                {% set cat_label_primary = t("category_beauty") %}
                {% set cat_label_secondary = t("category_beauty") %}
              {% elif cat_key == "-" %}
                {% set cat_label_primary = "-" %}
                {% set cat_label_secondary = "-" %}
              {% else %}
                {% set cat_label_primary = cat_key %}
                {% set cat_label_secondary = cat_key %}
              {% endif %}

              {% set lang_key = task.content_lang or "-" %}
              {% if lang_key == "mm" %}
                {% set lang_label = "MM" %}
              {% elif lang_key == "en" %}
                {% set lang_label = "EN" %}
              {% elif lang_key == "zh" %}
                {% set lang_label = "ZH" %}
              {% else %}
                {% set lang_label = lang_key %}
              {% endif %}

              {% set platform_key = (task.platform or "") | lower %}
              {% if platform_key == "douyin" %}
                {% set platform_label_primary = "Douyin" %}
                {% set platform_label_secondary = "Douyin" %}
              {% elif platform_key == "tk" or platform_key == "tiktok" %}
                {% set platform_label_primary = "TikTok" %}
                {% set platform_label_secondary = "TikTok" %}
              {% elif platform_key == "xhs" %}
                {% set platform_label_primary = "XHS" %}
                {% set platform_label_secondary = "XHS" %}
              {% elif platform_key == "fb" or platform_key == "facebook" %}
                {% set platform_label_primary = "Facebook" %}
                {% set platform_label_secondary = "Facebook" %}
              {% elif platform_key == "" %}
                {% set platform_label_primary = "-" %}
                {% set platform_label_secondary = "-" %}
              {% else %}
                {% set platform_label_primary = task.platform %}
                {% set platform_label_secondary = task.platform %}
              {% endif %}

              <tr>
                <td class="truncate" data-label="{{ t('tasks.table.id') }}" title="{{ task.task_id }}"><a href="/tasks/{{ task.task_id }}">{{ task.task_id }}</a></td>
                <td data-label="{{ t('tasks.table.platform') }}">
                  <div class="bilingual">
                    <span>{{ platform_label_primary }}</span>
                    {% if ui_show_secondary %}
                      <span class="secondary">{{ platform_label_secondary }}</span>
                    {% endif %}
                  </div>
                </td>
                <td class="truncate" data-label="{{ t('tasks.table.source') }}" title="{{ task.source_url }}">
                  {% if task.source_url %}
                    <span class="source-text">{{ task.source_url }}</span>
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="truncate" data-label="{{ t('tasks.table.title') }}" title="{{ task.title }}">{{ task.title or "" }}</td>
                <td data-label="{{ t('tasks.table.category') }}">
                  <div class="bilingual">
                    <span>{{ cat_label_primary }}</span>
                    {% if ui_show_secondary %}
                      <span class="secondary">{{ cat_label_secondary }}</span>
                    {% endif %}
                  </div>
                </td>
                <td data-label="{{ t('tasks.table.language') }}">{{ lang_label or "-" }}</td>
                <td data-label="{{ t('tasks.table.status') }}">
                  <div class="bilingual">
                    <span class="{{ badge }}">{{ t(status_key) }}</span>
                    {% if ui_show_secondary %}
                      <span class="secondary">{{ t(status_key) }}</span>
                    {% endif %}
                  </div>
                </td>
                <td data-label="{{ t('tasks.table.created') }}">{{ task.created_at }}</td>
                <td data-label="{{ t('tasks.table.pack') }}">
                  {% if features.allow_pack_download %}
                    <div class="action-item">
                      <a href="/v1/tasks/{{ task.task_id }}/pack" target="_blank" rel="noopener">{{ t("action.download") }}</a>
                      {% if ui_show_secondary %}
                        <span class="secondary">{{ t("action.download") }}</span>
                      {% endif %}
                    </div>
                  {% else %}
                    {{ t("tasks.pack_unavailable") }}
                  {% endif %}
                </td>
                <td data-label="{{ t('tasks.table.publish') }}">
                  <div class="action-item">
                    <a href="/tasks/{{ task.task_id }}/publish">{{ t("tasks.publish_hub") }}</a>
                    {% if ui_show_secondary %}
                      <span class="secondary">{{ t("tasks.publish_hub") }}</span>
                    {% endif %}
                  </div>
                </td>
                <td data-label="{{ t('tasks.table.detail') }}">
                  <div class="action-stack">
                    <div class="action-item">
                      <a href="/tasks/{{ task.task_id }}/publish">{{ t("tasks.publish_hub") }}</a>
                      {% if ui_show_secondary %}
                        <span class="secondary">{{ t("tasks.publish_hub") }}</span>
                      {% endif %}
                    </div>
<div class="action-item">
                      <a href="/tasks/{{ task.task_id }}">{{ t("action.open") }}</a>
                      {% if ui_show_secondary %}
                        <span class="secondary">{{ t("action.open") }}</span>
                      {% endif %}
                    </div>
                    {% set pipeline = task.pipeline_config or {} %}
                    {% set subtitles_mode = pipeline.get("subtitles_mode", "whisper+gemini") %}
                    {% set dub_mode = pipeline.get("dub_mode", "auto-fallback") %}
                    <div class="action-item">
                      <span class="muted">{{ t("tasks.subtitles") }}: {{ subtitles_mode }}</span>
                    </div>
                    <div class="action-item">
                      <span class="muted">{{ t("tasks.dub") }}: {{ dub_mode }}</span>
                    </div>
                    <div class="action-item">
                      <button type="button"
                              class="link-button danger"
                              data-action="delete"
                              data-task-id="{{ task.task_id }}">
                        {{ t("action.delete") }}
                      </button>
                    </div>
                    <div class="action-item">
                      <a href="/api/tasks/{{ task.task_id }}" target="_blank" rel="noopener">{{ t("action.json") }}</a>
                      {% if ui_show_secondary %}
                        <span class="secondary">{{ t("action.json") }}</span>
                      {% endif %}
                    </div>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="/static/js/i18n_v185.js"></script>
  <script>
    window.__FEATURES__ = {{ features | tojson | safe }};
    const initialTasks = {{ tasks | tojson | safe }};
    const allowPackDownload = {{ "true" if features.allow_pack_download else "false" }};
    const tableBody = document.getElementById("task-table-body");
    const countPrimaryEl = document.getElementById("task-count-primary");
    const countSecondaryEl = document.getElementById("task-count-secondary");
    const showSecondary = {{ "true" if ui_show_secondary else "false" }};
    const TASKS_KIND = "{{ tasks_kind or 'tasks' }}";
    const I18N = window.__V185_I18N__ || { tr: (key, vars) => key };
    const LABELS = {
      id: "{{ t('tasks.table.id') }}",
      platform: "{{ t('tasks.table.platform') }}",
      source: "{{ t('tasks.table.source') }}",
      title: "{{ t('tasks.table.title') }}",
      category: "{{ t('tasks.table.category') }}",
      lang: "{{ t('tasks.table.language') }}",
      status: "{{ t('tasks.table.status') }}",
      created: "{{ t('tasks.table.created') }}",
      pack: "{{ t('tasks.table.pack') }}",
      detail: "{{ t('tasks.table.detail') }}",
    };
    const STATUS_LABELS = {
      ready: { primary: "{{ t('tasks.status.ready') }}", secondary: "" },
      processing: { primary: "{{ t('tasks.status.processing') }}", secondary: "" },
      pending: { primary: "{{ t('tasks.status.queued') }}", secondary: "" },
      error: { primary: "{{ t('tasks.status.failed') }}", secondary: "" },
      unknown: { primary: "{{ t('tasks.status.failed') }}", secondary: "" },
    };
    const CATEGORY_LABELS = {
      suitcase: { primary: "{{ t('category_suitcase') }}", secondary: "{{ t('category_suitcase') }}" },
      beauty: { primary: "{{ t('category_beauty') }}", secondary: "{{ t('category_beauty') }}" },
      other: { primary: "{{ t('category_other') }}", secondary: "{{ t('category_other') }}" },
    };
    const PLATFORM_LABELS = {
      douyin: { primary: "{{ t('label.platform_douyin') }}", secondary: "" },
      tk: { primary: "{{ t('label.platform_tiktok') }}", secondary: "" },
      tiktok: { primary: "{{ t('label.platform_tiktok') }}", secondary: "" },
      xhs: { primary: "{{ t('label.platform_xhs') }}", secondary: "" },
      fb: { primary: "{{ t('label.platform_fb') }}", secondary: "" },
      facebook: { primary: "{{ t('label.platform_fb') }}", secondary: "" },
    };
    const COUNT_LABEL = "{{ t('tasks.loaded_n', n='{n}') }}";
    const DELETE_LABEL = "{{ delete_label }}";
    const EMPTY_LABEL = "{{ t('tasks.no_tasks') }}";

    function statusBadgeClass(status) {
      if (status === "ready") return "badge badge-ready";
      if (status === "processing") return "badge badge-processing";
      if (status === "pending") return "badge badge-pending";
      if (status === "error") return "badge badge-error";
      return "badge badge-unknown";
    }

    function categoryLabel(key) {
      if (!key) return { primary: "-", secondary: "-" };
      const lower = String(key).toLowerCase();
      if (CATEGORY_LABELS[lower]) return CATEGORY_LABELS[lower];
      return { primary: key, secondary: key };
    }

    function platformLabel(key) {
      if (!key) return { primary: "-", secondary: "-" };
      const lower = String(key).toLowerCase();
      if (PLATFORM_LABELS[lower]) return PLATFORM_LABELS[lower];
      return { primary: key, secondary: key };
    }

    function statusLabel(status) {
      if (!status) return STATUS_LABELS.unknown;
      const lower = String(status).toLowerCase();
      return STATUS_LABELS[lower] || STATUS_LABELS.unknown;
    }

    function langLabel(code) {
      if (!code) return "-";
      const lower = String(code).toLowerCase();
      if (lower === "mm") return "MM";
      if (lower === "en") return "EN";
      if (lower === "zh") return "ZH";
      return code;
    }

    function truncate(text, limit = 240) {
      if (!text) return "";
      return text.length > limit ? `${text.slice(0, limit - 1)}…` : text;
    }

    function extractFirstHttpUrl(text) {
      if (!text) return null;
      const s = String(text);
      const m = s.match(/https?:\/\/[^\s]+/i);
      return m ? m[0] : null;
    }

    function enhanceSourceLinks() {
      document.querySelectorAll("td .source-text").forEach((el) => {
        const raw = el.textContent || "";
        const url = extractFirstHttpUrl(raw);
        if (!url) return;
        const a = document.createElement("a");
        a.href = url;
        a.target = "_blank";
        a.rel = "noopener";
        a.textContent = el.textContent;
        el.replaceWith(a);
      });
    }

    function renderTasks(tasks) {
      tableBody.innerHTML = "";

      if (!tasks.length) {
        const emptyRow = document.createElement("tr");
        const emptyCell = document.createElement("td");
        emptyCell.colSpan = 10;
        emptyCell.className = "empty muted";
        emptyCell.innerHTML = `
          <div class="bilingual">
            <span>${EMPTY_LABEL}</span>
            ${showSecondary ? `<span class="secondary"></span>` : ""}
          </div>
        `;
        emptyRow.appendChild(emptyCell);
        tableBody.appendChild(emptyRow);
      } else {
        for (const t of tasks) {
          const status = t.status || "unknown";
          const catLabel = categoryLabel(t.category_key);
          const statusLabels = statusLabel(status);
          const lang = langLabel(t.content_lang);
          const platform = platformLabel(t.platform);
          const srcRaw = t.source_url || "";
          const srcUrl = extractFirstHttpUrl(srcRaw);
          const row = document.createElement("tr");
          const pipeline = t.pipeline_config || {};
          const subtitlesMode = pipeline.subtitles_mode || "whisper+gemini";
          const dubMode = pipeline.dub_mode || "auto-fallback";
          row.innerHTML = `
            <td class="truncate" data-label="${LABELS.id}" title="${t.task_id || ""}"><a href="/tasks/${t.task_id}">${truncate(t.task_id, 16)}</a></td>
            <td data-label="${LABELS.platform}">
              <div class="bilingual">
                <span>${platform.primary}</span>
                ${showSecondary ? `<span class="secondary">${platform.secondary}</span>` : ""}
              </div>
            </td>
            <td class="truncate" data-label="${LABELS.source}" title="${srcRaw}">
              ${srcRaw
                ? (srcUrl
                  ? `<a href="${srcUrl}" target="_blank" rel="noopener">${truncate(srcRaw, 48)}</a>`
                  : `<span class="muted">${truncate(srcRaw, 48)}</span>`)
                : "-"}
            </td>
            <td class="truncate" data-label="${LABELS.title}" title="${t.title || ""}">${t.title || ""}</td>
            <td data-label="${LABELS.category}">
              <div class="bilingual">
                <span>${catLabel.primary}</span>
                ${showSecondary ? `<span class="secondary">${catLabel.secondary}</span>` : ""}
              </div>
            </td>
            <td data-label="${LABELS.lang}">${lang}</td>
            <td data-label="${LABELS.status}">
              <div class="bilingual">
                <span class="${statusBadgeClass(status)}">${statusLabels.primary}</span>
                ${showSecondary ? `<span class="secondary">${statusLabels.secondary}</span>` : ""}
              </div>
            </td>
            <td data-label="${LABELS.created}">${t.created_at || ""}</td>
            <td data-label="${LABELS.pack}">${
              (allowPackDownload)
                ? `<div class="action-item">
                    <a href="/v1/tasks/${t.task_id}/pack" target="_blank" rel="noopener">{{ t("action.download") }}</a>
                    ${showSecondary ? `<span class="secondary">{{ t("download") }}</span>` : ""}
                  </div>`
                : I18N.t("tasks.pack_unavailable")
            }</td>
            <td data-label="${LABELS.detail}">
              <div class="action-stack">
                <div class="action-item">
                  <a href="/tasks/${t.task_id}">{{ t("action.open") }}</a>
                  ${showSecondary ? `<span class="secondary">{{ t("open") }}</span>` : ""}
                </div>
                <div class="action-item">
                  <span class="muted">${I18N.t("tasks.subtitles")}: ${subtitlesMode}</span>
                </div>
                <div class="action-item">
                  <span class="muted">${I18N.t("tasks.dub")}: ${dubMode}</span>
                </div>
                <div class="action-item">
                  <button type="button"
                          class="link-button danger"
                          data-action="delete"
                          data-task-id="${t.task_id}">
                    ${DELETE_LABEL}
                  </button>
                </div>
                <div class="action-item">
                  <a href="/api/tasks/${t.task_id}" target="_blank" rel="noopener">{{ t("action.json") }}</a>
                  ${showSecondary ? `<span class="secondary">{{ t("json") }}</span>` : ""}
                </div>
              </div>
            </td>
          `;
          tableBody.appendChild(row);
        }
      }

      enhanceSourceLinks();
      const count = tasks.length;
      if (countPrimaryEl) {
        countPrimaryEl.textContent = COUNT_LABEL.replace("{n}", count);
      }
      if (countSecondaryEl) {
        countSecondaryEl.textContent = "";
      }
    }

    let tasksPollTimer = null;
    let tasksInFlight = false;
    const TASKS_POLL_MS = 10000;
    let currentPollMs = TASKS_POLL_MS;

    function stopTasksPolling() {
      if (!tasksPollTimer) return;
      clearInterval(tasksPollTimer);
      tasksPollTimer = null;
    }

    function startTasksPolling() {
      if (tasksPollTimer) return;
      fetchTasksOnce();
      tasksPollTimer = setInterval(fetchTasksOnce, currentPollMs);
    }

    function restartTasksPolling() {
      if (!tasksPollTimer) return;
      stopTasksPolling();
      tasksPollTimer = setInterval(fetchTasksOnce, currentPollMs);
    }

    async function fetchTasksOnce() {
      if (document.visibilityState !== "visible") return;
      if (tasksInFlight) return;

      tasksInFlight = true;
      if (countPrimaryEl) {
        countPrimaryEl.textContent = I18N.t("tasks.loading");
      }
      if (countSecondaryEl) {
        countSecondaryEl.textContent = "";
      }
      try {
        const kindParam = TASKS_KIND === "apollo_avatar" ? "&kind=apollo_avatar" : "";
        const url = `/api/tasks?limit=50${kindParam}&ts=${Date.now()}`;
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const tasks = Array.isArray(data) ? data : (data.items || []);
        renderTasks(tasks);
        if (currentPollMs != TASKS_POLL_MS) {
          currentPollMs = TASKS_POLL_MS;
          restartTasksPolling();
        }
      } catch (err) {
        console.error(err);
        if (countPrimaryEl) {
          countPrimaryEl.textContent = I18N.t("tasks.load_failed", { error: err.message });
        }
        if (countSecondaryEl) {
          countSecondaryEl.textContent = "";
        }
        const nextMs = Math.min(currentPollMs * 2, 60000);
        if (nextMs != currentPollMs) {
          currentPollMs = nextMs;
          restartTasksPolling();
        }
      } finally {
        tasksInFlight = false;
      }
    }

    renderTasks(initialTasks || []);

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible") {
        startTasksPolling();
      } else {
        stopTasksPolling();
      }
    });

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", startTasksPolling, { once: true });
    } else {
      startTasksPolling();
    }

    async function handleDeleteClick(event) {
      const button = event.target.closest("[data-action='delete']");
      if (!button) return;
      if (button.getAttribute("data-action") !== "delete") return;
      event.preventDefault();
      const taskId = button.dataset.taskId;
      if (!taskId) return;
      const confirmed = window.confirm(I18N.t("tasks.delete_confirm"));
      if (!confirmed) return;
      const originalText = button.textContent;
      button.disabled = true;
      button.textContent = I18N.t("tasks.deleting");
      try {
        const res = await fetch(`/api/tasks/${encodeURIComponent(taskId)}?delete_assets=false`, {
          method: "DELETE",
        });
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        const row = button.closest("tr");
        if (row) {
          row.remove();
        }
        if (typeof fetchTasksOnce === "function") {
          fetchTasksOnce();
        }
      } catch (err) {
        console.error(err);
        window.alert(I18N.t("tasks.delete_failed", { error: err.message }));
      } finally {
        button.disabled = false;
        button.textContent = originalText;
      }
    }

    if (tableBody) {
      tableBody.addEventListener("click", handleDeleteClick);
    }

    // Polling is driven by the visibility handler above.
  </script>
</body>
</html>







