<!doctype html>
<html lang="zh-CN" class="bg-gray-50">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>{{ t("page.tasks.board.title") }} - ShortVideo</title>

  <!-- Tailwind CDN for PR-UI-1 (board only) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Keep existing i18n + ui skin -->
  <link rel="stylesheet" href="/static/i18n.css" />
  <link rel="stylesheet" href="/static/css/ui_v185.css">

  <style>
    :root { color-scheme: light; }
    body { margin:0; padding: 16px; background:#f3f4f6; color:#0f172a; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    .page { max-width: 1200px; margin: 0 auto; }
  </style>
</head>

<body class="{{ 'mobile' if is_mobile else 'desktop' }}">
  <div class="page">
    <header class="mb-4 flex flex-wrap items-center gap-3">
      <div class="flex-1">
        <div class="flex items-center gap-2">
          <h1 class="text-2xl font-bold text-gray-900">{{ t("ui.tasks.board") }}</h1>
          <span class="rounded-full bg-gray-100 px-2 py-0.5 text-xs text-gray-600">v1.9</span>
        </div>
        <p class="mt-1 text-sm text-gray-500">{{ t("tasks.board.subhead") }}</p>
      </div>
      <div class="flex items-center gap-2">
        {% include "_lang_tabs.html" %}
        <a href="/tasks/new" class="inline-flex items-center rounded-md bg-gray-900 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-gray-800">
          {{ t("common.new_task") }}
        </a>
      </div>
    </header>

    <div class="mb-3 flex flex-wrap items-center gap-2">
      <div class="inline-flex rounded-lg border border-gray-200 bg-white p-1 text-sm">
        <button class="status-btn rounded-md px-3 py-1.5 data-[active=true]:bg-gray-900 data-[active=true]:text-white"
                data-status="all" data-active="true">{{ t("tasks.status.all") }}</button>
        <button class="status-btn rounded-md px-3 py-1.5 text-gray-700 hover:bg-gray-50"
                data-status="processing">{{ t("tasks.status.processing") }}</button>
        <button class="status-btn rounded-md px-3 py-1.5 text-gray-700 hover:bg-gray-50"
                data-status="done">{{ t("tasks.status.done") }}</button>
        <button class="status-btn rounded-md px-3 py-1.5 text-gray-700 hover:bg-gray-50"
                data-status="attention">{{ t("tasks.status.attention") }}</button>
      </div>
    </div>

    <div class="mb-4 flex flex-wrap items-center gap-2">
      <div class="inline-flex rounded-lg border border-gray-200 bg-white p-1 text-sm">
        <button class="scene-btn rounded-md px-3 py-1.5 data-[active=true]:bg-gray-900 data-[active=true]:text-white"
                data-scene="all" data-active="true">{{ t("tasks.scene.all") }}</button>
        <button class="scene-btn rounded-md px-3 py-1.5 text-gray-700 hover:bg-gray-50"
                data-scene="avatar">{{ t("tasks.scene.avatar") }}</button>
        <button class="scene-btn rounded-md px-3 py-1.5 text-gray-700 hover:bg-gray-50"
                data-scene="hot">{{ t("tasks.scene.hot") }}</button>
        <button class="scene-btn rounded-md px-3 py-1.5 text-gray-700 hover:bg-gray-50"
                data-scene="baseline">{{ t("tasks.scene.baseline") }}</button>
      </div>
      <div class="ml-auto text-sm text-gray-500" id="boardMessage">{{ t("tasks.loaded_n", n=(tasks|length)) }}</div>
    </div>

    <div class="bg-white shadow-sm ring-1 ring-gray-900/5 sm:rounded-xl">
      <div id="taskList" class="divide-y divide-gray-100">
        {% for task in tasks %}
          {% set title = task.title_text or t("tasks.unnamed") %}
          {% set subtitle = task.subtitle_text or "" %}
          {% set scene_label = t(task.scene_label_key) %}
          {% if task.processing %}
            {% set status_key = "processing" %}
          {% elif task.done %}
            {% set status_key = "done" %}
          {% elif task.needs_attention %}
            {% set status_key = "attention" %}
          {% else %}
            {% set status_key = "other" %}
          {% endif %}

          <div class="task-row relative flex justify-between gap-x-6 px-4 py-4 sm:px-6 hover:bg-gray-50 {% if task.yellow %} bg-yellow-50/30 {% endif %}"
               data-scene="{{ task.scene_key }}" data-status="{{ status_key }}">
            <div class="flex min-w-0 gap-x-4">
              <div class="h-16 w-16 flex-none rounded-lg bg-gray-200 overflow-hidden flex items-center justify-center">
                {% if task.thumb_url %}
                  <img class="h-full w-full object-cover" src="{{ task.thumb_url }}" alt="thumb" />
                {% else %}
                  <span class="text-gray-400 text-xl"></span>
                {% endif %}
              </div>

              <div class="min-w-0 flex-auto">
                <p class="text-sm font-semibold leading-6 text-gray-900 line-clamp-1">{{ title }}</p>
                {% if subtitle %}
                  <p class="mt-1 flex text-xs leading-5 text-gray-500 gap-2">{{ subtitle }}</p>
                {% endif %}

                <div class="mt-1 flex gap-2 flex-wrap">
                  {% if task.pack_exists %}
                    <span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium ring-1 ring-inset bg-green-50 text-green-700 ring-green-600/20">
                      {{ t("tasks.badge.pack_ready") if task.done else t("tasks.badge.pack_exists") }}
                    </span>
                  {% endif %}
                  {% if task.video_exists %}
                    <span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium ring-1 ring-inset bg-blue-50 text-blue-700 ring-blue-700/10">
                      {{ t("tasks.badge.video") }}
                    </span>
                  {% endif %}
                  {% if task.yellow %}
                    <span class="text-xs text-amber-700">{{ t("tasks.badge.warn_but_usable") }}</span>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="flex items-center gap-x-4">
              <div class="hidden sm:flex sm:flex-col sm:items-end">
                <p class="text-sm leading-6 text-gray-900">{{ scene_label }}</p>
                <p class="mt-1 text-xs leading-5 text-gray-500">{{ task.created_label }}</p>
              </div>

              <div class="flex items-center gap-2">
                {% if task.yellow %}
                  <a href="{{ task.pack_download_url }}" target="_blank" rel="noopener"
                     class="rounded bg-indigo-50 px-2 py-1 text-sm font-semibold text-indigo-600 ring-1 ring-inset ring-indigo-300 hover:bg-indigo-100">
                    {{ t("tasks.action.force_download") }}
                  </a>
                {% elif task.pack_exists %}
                  <a href="{{ task.pack_download_url }}" target="_blank" rel="noopener"
                     class="rounded bg-white px-2 py-1 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                    {{ t("tasks.action.download") }}
                  </a>
                {% else %}
                  <button class="rounded bg-gray-100 px-2 py-1 text-sm font-semibold text-gray-400 cursor-not-allowed">
                    {{ t("tasks.action.download") }}
                  </button>
                {% endif %}

                <a href="{{ task.primary_action_url }}" class="rounded bg-gray-900 px-2 py-1 text-sm font-semibold text-white hover:bg-gray-800">
                  {{ t("tasks.action.open") }}
                </a>
                <a href="{{ task.primary_action_url }}" class="text-gray-400 hover:text-gray-600" aria-label="detail">?</a>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
      <div id="emptyState" class="hidden p-6 text-center text-sm text-gray-500">
        {{ t("tasks.empty") }}
      </div>
    </div>
  </div>

  <script src="/static/js/i18n_v185.js"></script>
  <script>
    function applyFilters() {
      const rows = Array.from(document.querySelectorAll(".task-row"));
      let shown = 0;
      const curStatus = document.querySelector(".status-btn[data-active='true']")?.dataset.status || "all";
      const curScene = document.querySelector(".scene-btn[data-active='true']")?.dataset.scene || "all";
      rows.forEach((r) => {
        const rs = r.getAttribute("data-status") || "other";
        const rc = r.getAttribute("data-scene") || "baseline";
        const okStatus = (curStatus === "all") ? true : (rs === curStatus);
        const okScene = (curScene === "all") ? true : (rc === curScene);
        const show = okStatus && okScene;
        r.style.display = show ? "" : "none";
        if (show) shown++;
      });
      const msg = document.getElementById("boardMessage");
      if (msg) msg.textContent = {{ t("tasks.filtered_n", n="{n}") | tojson }}.replace("{n}", String(shown));

      const empty = document.getElementById("emptyState");
      if (empty) {
        if (shown === 0) empty.classList.remove("hidden");
        else empty.classList.add("hidden");
      }
    }

    function bindTabs(selector, key) {
      const btns = Array.from(document.querySelectorAll(selector));
      btns.forEach((b) => {
        b.addEventListener("click", () => {
          btns.forEach(x => x.dataset.active = "false");
          b.dataset.active = "true";
          applyFilters();
        });
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      bindTabs(".status-btn", "status");
      bindTabs(".scene-btn", "scene");
      applyFilters();
    });
  </script>
</body>
</html>