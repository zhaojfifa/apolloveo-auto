<!doctype html>
<html lang="zh-CN" class="bg-gray-50">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>{{ t("page.tasks.board.title") }} - ShortVideo</title>

  <!-- Tailwind CDN for PR-UI-1 (board only) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Keep existing i18n + ui skin -->
  <link rel="stylesheet" href="/static/i18n.css" />
  <link rel="stylesheet" href="/static/css/ui_v185.css">

  <style>
    :root { color-scheme: light; }
    body { margin:0; padding: 16px; background:#f3f4f6; color:#0f172a; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    .page { max-width: 1200px; margin: 0 auto; }
  </style>
</head>

<body class="{{ 'mobile' if is_mobile else 'desktop' }}">
  <div class="page">
    <header class="tasks-header mb-4">
      <div>
        <div class="tasks-header__title">{{ t("ui.tasks.board") }}</div>
        <div class="tasks-header__subtitle">{{ t("tasks.board.subhead") }}</div>
      </div>
      <div class="tasks-actions">
        {% include "_lang_tabs.html" %}
        <a href="/tasks/newtasks" class="btn-cta">{{ t("common.new_task") }}</a>
      </div>
    </header>

    <div class="filter-console">
      <div class="scene-tabs">
        <button class="scene-tab" data-scene="all" data-active="true">{{ t("tasks.filter.scene.all") }}</button>
        <button class="scene-tab" data-scene="avatar">{{ t("tasks.filter.scene.avatar") }}</button>
        <button class="scene-tab" data-scene="hot_follow">{{ t("tasks.filter.scene.hot_follow") }}</button>
        <button class="scene-tab" data-scene="baseline">{{ t("tasks.filter.scene.baseline") }}</button>
      </div>
      <div class="status-legend">
        <span class="status-legend__label">状态</span>
        <button class="status-item" data-status="all" data-active="true"><span class="status-dot"></span>{{ t("tasks.filter.status.all") }}</button>
        <button class="status-item" data-status="processing"><span class="status-dot status-dot--orange"></span>{{ t("tasks.filter.status.processing") }}</button>
        <button class="status-item" data-status="done"><span class="status-dot status-dot--green"></span>{{ t("tasks.filter.status.done") }}</button>
        <button class="status-item" data-status="attention"><span class="status-dot status-dot--red"></span>{{ t("tasks.filter.status.attention") }}</button>
      </div>
    </div>
    <div class="text-sm text-gray-500 mt-2" id="boardMessage">{{ t("tasks.filtered_n", n=(items|length)) }}</div>

    <div id="taskList" class="tasks-grid">
      {% for it in items %}
        {% set task_id = it.task_id or it.id %}
        {% set title = it.title or it.task_title or (it.meta.title if it.meta and it.meta.title) or it.title_display or t("tasks.untitled") %}
        {% set cover = it.cover_url or it.cover or it.cover_head or it.thumb_url or "" %}
        {% set platform = it.platform or it.source_platform or it.site or "-" %}
        {% set created = it.created_label or it.created_at or it.created_time or it.created or "" %}
        {% set scene_raw = (it.kind or it.category or it.scene or "baseline") | lower %}
        {% if it.scene_label_key %}
          {% set scene_label = t(it.scene_label_key) %}
        {% elif "avatar" in scene_raw %}
          {% set scene_label = t("tasks.filter.scene.avatar") %}
        {% elif "hot" in scene_raw %}
          {% set scene_label = t("tasks.filter.scene.hot_follow") %}
        {% else %}
          {% set scene_label = t("tasks.filter.scene.baseline") %}
        {% endif %}
        {% set status_value = it.filter_status or it.status or "unknown" %}
        {% if status_value == "done" %}
          {% set status_label = t("tasks.filter.status.done") %}
          {% set badge_class = "badge-green" %}
        {% elif status_value == "processing" %}
          {% set status_label = t("tasks.filter.status.processing") %}
          {% set badge_class = "badge-yellow" %}
        {% elif status_value == "attention" or status_value == "failed" %}
          {% set status_label = t("tasks.filter.status.attention") %}
          {% set badge_class = "badge-red" %}
        {% elif status_value == "queued" %}
          {% set status_label = t("status.queued") %}
          {% set badge_class = "badge-blue" %}
        {% else %}
          {% set status_label = t("status.unknown") %}
          {% set badge_class = "badge-gray" %}
        {% endif %}
        <div class="task-card task-row" data-scene="{{ it.scene_key or scene_raw }}" data-status="{{ status_value }}">
          <div class="task-card__left">
            {% if cover %}
              <img class="task-card__cover" src="{{ cover }}" alt="cover" />
            {% else %}
              <div class="task-card__cover"></div>
            {% endif %}
            <div class="task-card__info">
              <div class="task-card__title">{{ title }}</div>
              <div class="task-card__meta">
                <span>{{ platform }}</span>
                <span>&middot;</span>
                <span>ID: {{ task_id }}</span>
              </div>
              <div class="task-card__meta">
                <span class="task-pill">{{ scene_label }}</span>
                {% if created %}
                  <span title="{{ it.created_at or created }}">{{ created }}</span>
                {% endif %}
              </div>
              <div class="task-card__meta">
                {% if it.show_pack_badge %}
                  <span class="task-pill">{{ t(it.pack_badge_label_key) }}</span>
                {% endif %}
                {% if it.show_video_badge %}
                  <span class="task-pill">{{ t("tasks.badge.video") }}</span>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="task-card__right">
            <span class="task-badge {{ badge_class }}">{{ status_label }}</span>
            <div class="task-actions">
              {% if it.download_class %}
                <a href="{{ it.pack_download_href }}" target="_blank" rel="noopener" class="btn-primary">
                  {{ t(it.download_label_key) }}
                </a>
              {% else %}
                <button class="btn-primary" disabled>
                  {{ t(it.download_label_key) }}
                </button>
              {% endif %}
              <a href="{{ it.primary_action_href }}" class="btn-secondary">{{ t("action.open_detail") }}</a>
              <button class="btn-danger-link" data-action="delete" data-id="{{ task_id }}"
                      onclick="deleteTask('{{ task_id }}'); return false;">
                {{ t("action.delete") }}
              </button>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
    <div id="emptyState" class="hidden p-6 text-center text-sm text-gray-500">
      {{ t("tasks.empty") }}
    </div>
  </div>

  <script src="/static/js/i18n_v185.js"></script>
  <script>
    async function deleteTask(taskId){
      if (!taskId) return;
      if (!confirm("Delete task " + taskId + " ?")) return;

      try{
        const resp = await fetch(`/api/tasks/${encodeURIComponent(taskId)}?delete_assets=false`, {
          method: "DELETE",
          headers: {"Content-Type":"application/json"},
        });
        if(!resp.ok){
          const txt = await resp.text();
          alert("Delete failed: " + resp.status + " " + txt);
          return;
        }
        location.reload();
      }catch(e){
        alert("Delete error: " + e.message);
      }
    }

    function applyFilters() {
      const rows = Array.from(document.querySelectorAll(".task-row"));
      let shown = 0;
      const curStatus = document.querySelector(".status-item[data-active='true']")?.dataset.status || "all";
      const curScene = document.querySelector(".scene-tab[data-active='true']")?.dataset.scene || "all";
      rows.forEach((r) => {
        const rs = r.getAttribute("data-status") || "other";
        const rc = r.getAttribute("data-scene") || "baseline";
        const okStatus = (curStatus === "all") ? true : (rs === curStatus);
        const okScene = (curScene === "all") ? true : (rc === curScene);
        const show = okStatus && okScene;
        r.style.display = show ? "" : "none";
        if (show) shown++;
      });
      const msg = document.getElementById("boardMessage");
      if (msg) msg.textContent = {{ t("tasks.filtered_n", n="{n}") | tojson }}.replace("{n}", String(shown));

      const empty = document.getElementById("emptyState");
      if (empty) {
        if (shown === 0) empty.classList.remove("hidden");
        else empty.classList.add("hidden");
      }
    }

    function bindTabs(selector) {
      const btns = Array.from(document.querySelectorAll(selector));
      btns.forEach((b) => {
        b.addEventListener("click", () => {
          btns.forEach(x => x.dataset.active = "false");
          b.dataset.active = "true";
          applyFilters();
        });
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      bindTabs(".status-item");
      bindTabs(".scene-tab");
      applyFilters();
    });
  </script>
</body>
</html>
